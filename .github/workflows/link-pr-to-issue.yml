name: Link PR to Issue by NOCOUNTRY key

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  link:
    runs-on: ubuntu-latest
    steps:
      - name: Link PR to issue
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;

            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º PR –∏–∑ fork ‚Äî –Ω–µ—Ç –ø—Ä–∞–≤ –ø–∏—Å–∞—Ç—å
            if (pr.head.repo.full_name !== pr.base.repo.full_name) {
              console.log("‚ö†Ô∏è PR is from a fork ‚Äî skipping linking");
              return;
            }

            // –ò—â–µ–º –ø—Ä–µ—Ñ–∏–∫—Å –≤–∏–¥–∞ NOCOUNTRY-123 –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ PR
            const match = pr.title.match(/NOCOUNTRY-(\d+)/i);
            if (!match) {
              console.log("‚ùå No NOCOUNTRY-<number> found in PR title");
              return;
            }

            const issueNumber = match[1];
            const issueKey = `NOCOUNTRY-${issueNumber}`;

            // –ò—â–µ–º issue —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º NOCOUNTRY-123 –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open"
            });

            const linkedIssue = issues.find(i => i.title.includes(issueKey));
            if (!linkedIssue) {
              console.log(`‚ö†Ô∏è Issue with prefix ${issueKey} not found`);
              return;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ issue —Å–æ —Å—Å—ã–ª–∫–æ–π –Ω–∞ PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: linkedIssue.number,
              body: `üîó **PR #${pr.number}** —Ñ–∏–∫—Å–∏—Ç —ç—Ç—É issue: [${pr.title}](${pr.html_url})`
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Ç–µ–ª–æ PR —Å—Å—ã–ª–∫—É –Ω–∞ issue
            const newBody = `${pr.body || ""}\n\n**–°–≤—è–∑–∞–Ω–Ω–∞—è issue:** #${linkedIssue.number}`;
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              body: newBody
            });

            console.log(`‚úÖ Linked PR #${pr.number} ‚Üí Issue #${linkedIssue.number} (${issueKey})`);
