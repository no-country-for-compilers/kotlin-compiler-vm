name: Link PR to Issue

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]
permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  link:
    runs-on: ubuntu-latest
    steps:
      - name: Link PR with issue by NOCOUNTRY key
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const match = pr.title.match(/NOCOUNTRY-(\d+)/i);
            if (!match) {
              console.log("‚ùå PR title doesn't contain NOCOUNTRY-<number>");
              return;
            }
            const issueKey = `NOCOUNTRY-${match[1]}`;

            // –ù–∞–π–¥—ë–º issue —Å —Ç–∞–∫–∏–º –∂–µ –Ω–æ–º–µ—Ä–æ–º –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open"
            });

            const linkedIssue = issues.find(i => i.title.includes(issueKey));
            if (!linkedIssue) {
              console.log(`‚ö†Ô∏è Issue ${issueKey} not found.`);
              return;
            }

            // –î–æ–±–∞–≤–∏–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π-—Å—Å—ã–ª–∫—É
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: linkedIssue.number,
              body: `üîó –°–≤—è–∑–∞–Ω–æ —Å PR #${pr.number} (${pr.title})`
            });

            // –û–±–Ω–æ–≤–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ PR, –¥–æ–±–∞–≤–∏–≤ —Å—Å—ã–ª–∫—É
            const newBody = `${pr.body || ""}\n\nFixes #${linkedIssue.number}`;
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              body: newBody
            });

            console.log(`‚úÖ –°–≤—è–∑–∞–Ω–æ: ${issueKey} ‚Üí PR #${pr.number}`);
